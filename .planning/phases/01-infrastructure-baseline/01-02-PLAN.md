---
phase: 01-infrastructure-baseline
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - livekit_agent/src/agent.py
autonomous: true
requirements:
  - INFR-02

must_haves:
  truths:
    - "When OpenRouter rate limit is hit, the assistant speaks a brief holding message before retrying"
    - "When all retries and fallbacks are exhausted, the assistant speaks an apology and waits for next input"
    - "The holding message is spoken only once per error episode, not on every retry"
    - "Detailed errors are logged to console for debugging"
  artifacts:
    - path: "livekit_agent/src/agent.py"
      provides: "Session error event handler with verbal fallback"
      contains: "session.say"
  key_links:
    - from: "livekit_agent/src/agent.py"
      to: "AgentSession error event"
      via: "session.on('error') or equivalent event subscription"
      pattern: "on.*error|error.*handler"
    - from: "livekit_agent/src/agent.py"
      to: "session.say()"
      via: "Verbal notification to user during error"
      pattern: "session\\.say"
---

<objective>
Add verbal error fallback so the assistant speaks to the user during LLM failures instead of going silent.

Purpose: When OpenRouter rate-limits or all models fail, the user hears a natural verbal message instead of silence. This is the key UX requirement for cloud-dependent LLM inference.

Output: Error handler in agent.py that speaks holding messages on transient errors and apology on terminal failure.
</objective>

<execution_context>
@/home/nc773/.claude/get-shit-done/workflows/execute-plan.md
@/home/nc773/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-baseline/01-CONTEXT.md
@.planning/phases/01-infrastructure-baseline/01-RESEARCH.md
@.planning/phases/01-infrastructure-baseline/01-01-SUMMARY.md
@livekit_agent/src/agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement verbal error fallback on session error events</name>
  <files>livekit_agent/src/agent.py</files>
  <action>
Add an error event handler to the AgentSession in `my_agent()` that speaks verbal messages to the user.

**IMPORTANT: Before implementing, read the livekit-agents source to verify the exact error event API.** Check:
- `livekit/agents/voice/agent.py` or equivalent in the installed package
- The event name (likely `"error"`)
- The handler signature and whether the error object has a `recoverable` field
- Whether `session.say()` is async or sync in that context

Run: `uv run python -c "import livekit.agents; print(livekit.agents.__file__)"` to find the package location, then read the relevant source file.

**Implementation (adjust based on source verification):**

1. After `session = AgentSession(...)` and before `await session.start(...)`, register an error handler.

2. The error handler should:
   - On recoverable/transient error (first occurrence): call `session.say("Hang on a sec.")` or similar casual message
   - On unrecoverable/terminal error: call `session.say("Sorry, I can't answer that right now.")`
   - Use a flag to prevent speaking the holding message multiple times per error episode
   - Log the full error details at ERROR level: `logger.error("LLM error: %s", error_details)`

3. Per user decisions:
   - Messages should be vague and friendly — no technical details
   - One generic message for all error types
   - Assistant stays listening after error — ready for next input
   - Detailed errors go to logger only

4. Reset the holding-message flag when session successfully processes a response (or when terminal error fires, whichever pattern the API supports).

If the error event API is significantly different from what research suggested (e.g., no `recoverable` field), adapt the approach: treat all errors as potentially transient, speak the holding message once, and speak the apology only if the session is about to close or disconnect.
  </action>
  <verify>
    <automated>cd /home/nc773/Documents/automates-local-voice-ai/livekit_agent && uv run ruff check src/agent.py && uv run ruff format --check src/agent.py && echo "PASS: lint and format clean"</automated>
    <manual>Review agent.py error handler: confirm session.say() is called with friendly messages, flag prevents repeated messages, errors are logged</manual>
  </verify>
  <done>AgentSession has error handler that speaks "Hang on a sec" on first transient error and "Sorry, I can't answer that right now" on terminal failure; holding message spoken only once per episode; detailed errors logged at ERROR level; assistant stays listening after error</done>
</task>

</tasks>

<verification>
1. `ruff check` and `ruff format --check` pass on agent.py
2. agent.py contains error event handler with `session.say()` calls
3. agent.py contains a flag/state variable preventing repeated holding messages
4. agent.py logs errors at ERROR level with details
5. No technical error details in spoken messages
</verification>

<success_criteria>
- Error handler registered on AgentSession
- Transient errors trigger one verbal holding message
- Terminal failures trigger verbal apology
- Holding message not repeated during same error episode
- All errors logged with full details for debugging
- Code passes ruff lint and format
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-baseline/01-02-SUMMARY.md`
</output>
